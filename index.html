
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>The Sheinburger</title>
  <meta name="author" content="Mike Sheinberg">

  
  <meta name="description" content="Installation Following directions from the Jenkins site, these are my notes to configuring a base Jenkins setup on Ubuntu 12.04. Let&rsquo;s first &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://msheiny.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="The Sheinburger" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Gloria+Hallelujah' rel='stylesheet' type='text/css'>

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">The Sheinburger</a></h1>
  
    <h2>Self-serving content since 2014</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:msheiny.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/05/jenkins-primer/">Jenkins Primer</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-05-05T19:05:57-04:00" pubdate data-updated="true">May 5<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>Installation</h1>

<p>Following directions from the <a href="https://wiki.jenkins-ci.org/display/JENKINS/Installing+Jenkins+on+Ubuntu">Jenkins</a> site, these are my notes to configuring a base Jenkins setup on Ubuntu 12.04. Let&rsquo;s first start by adding the jenkins repository, refreshing the apt repository listing, installing, and
starting up:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>wget -q -O - http://pkg.jenkins-ci.org/debian/jenkins-ci.org.key | sudo apt-key add -
</span><span class='line'>sudo sh -c <span class="s1">&#39;echo deb http://pkg.jenkins-ci.org/debian binary/ &gt; /etc/apt/sources.list.d/jenkins.list&#39;</span>
</span><span class='line'>sudo apt-get update
</span><span class='line'>sudo apt-get install jenkins
</span><span class='line'>sudo service jenkins start
</span></code></pre></td></tr></table></div></figure>


<p>By default, you&rsquo;ll be able to reach the jenkins server over HTTP on port 8080. Here is the screen you are greeted with:
<img class="center" src="/images/jenkins-install1.png"></p>

<p>Our jekins configuration files live at <code>/var/lib/jenkins</code> which happens to be the home directory for our new <code>jenkins</code> user. Here is a default directory listing upon installation:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>jenkins@precise64:~<span class="nv">$ </span>tree -d -L 2
</span><span class='line'>.
</span><span class='line'>|-- <span class="nb">jobs</span>
</span><span class='line'>|-- plugins
</span><span class='line'>|   |-- ant
</span><span class='line'>|   |-- antisamy-markup-formatter
</span><span class='line'>|   |-- credentials
</span><span class='line'>|   |-- cvs
</span><span class='line'>|   |-- external-monitor-job
</span><span class='line'>|   |-- javadoc
</span><span class='line'>|   |-- ldap
</span><span class='line'>|   |-- mailer
</span><span class='line'>|   |-- matrix-auth
</span><span class='line'>|   |-- matrix-project
</span><span class='line'>|   |-- maven-plugin
</span><span class='line'>|   |-- pam-auth
</span><span class='line'>|   |-- ssh-credentials
</span><span class='line'>|   |-- ssh-slaves
</span><span class='line'>|   |-- subversion
</span><span class='line'>|   |-- translation
</span><span class='line'>|   <span class="sb">`</span>-- windows-slaves
</span><span class='line'>|-- secrets
</span><span class='line'>|-- updates
</span><span class='line'><span class="sb">`</span>-- userContent
</span></code></pre></td></tr></table></div></figure>


<h1>Plug-ins</h1>

<p>Jenkins is configurable with <a href="https://wiki.jenkins-ci.org/display/JENKINS/Plugins">community plugins</a>. For my project, I wanted to include git support but by default jenkins only supports CVS and subversion. Turns out you can easily install plugins via the web-interface. Make sure you already have <code>git</code> installed on the jenkins server. From the main page:</p>

<ol>
<li>click <code>Manage Jekins</code></li>
<li><code>Manage Plugins</code></li>
<li><code>Available</code></li>
<li>Type &lsquo;git plugin&rsquo; in the search bar</li>
<li>Select the Git Plugin and <code>Download and Reboot</code> <img class="center" src="/images/jenkins-install-gitpl.png"></li>
<li>Select the option to reboot when no jobs are running</li>
</ol>


<h1>Run tests against a git project</h1>

<p>From our main jenkins page:</p>

<ol>
<li><code>New item</code></li>
<li>Fill out <code>Item name</code> and select <code>Build a free-style software project</code></li>
<li>Scroll down to source code management and select <code>git</code></li>
<li>Enter the URL of the git repository and any credentials you may need. For my test purposes I pointed to a file-system path that I have shared with my jenkins test server. If jenkins can&rsquo;t reach the git URL you&rsquo;ll get an error before you hit save which is nice.</li>
<li>Under <code>Build Triggers</code> &ndash; set up a schedule under <code>Poll SCM</code>. The syntax is similar to Unix crontab. The documentation recommends that you utilize an H in place of a field in order to help distribute the workload amongst multiple jobs. For example <code>H * * * *</code> will run a job every hour at a variable minute related to other scheduled jobs.</li>
<li>Finally under <code>build</code>/<code>Execute Shell</code> &ndash; set up the scripts that are necessary for testing your project. Here was an example for mine that I found from a <a href="http://iamnearlythere.com/jenkins-python-virtualenv/">blogger</a> :</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">PATH</span><span class="o">=</span><span class="nv">$WORKSPACE</span>/venv/bin:/usr/local/bin:<span class="nv">$PATH</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> ! -d <span class="s2">&quot;venv&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">        </span>virtualenv venv
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>. venv/bin/activate
</span><span class='line'>
</span><span class='line'>pip install -r requirements.txt
</span><span class='line'>nosetests -v -s
</span></code></pre></td></tr></table></div></figure>


<p>You can manually kick off a build from the Jenkins job page using <code>Build now</code>. You can follow it live with the console view to see the output from the scripts. The git files will be pulled into your build workspace which for our Ubuntu install was  <code>/var/lib/jenkins/jobs/project_name/workspace/</code></p>

<h1>Git Hook</h1>

<p>You can tie a build into your git repo using a <a href="http://git-scm.com/book/en/Customizing-Git-Git-Hooks">git hook</a> and by supplying a specially formatted HTTP GET request to your jenkins server. You won&rsquo;t have to authenticate to jenkins to kick this off, so just keep that in mind during deployment. It is recommended to use <code>curl</code> to kick this off using the following format:</p>

<p><code>curl http://yourserver/jenkins/git/notifyCommit?url=&lt;URL of the Git repository&gt;[&amp;branches=branch1[,branch2]*][&amp;sha1=&lt;commit ID&gt;]</code></p>

<p>The git jenkins plugin will determine what jobs are associated with the <code>&lt;URL of the Git repository&gt;</code> and start those builds. You&rsquo;ll need to setup some kind of polling configuration on the job in order for this to work right.</p>

<p>Overall it was fairly painless to get it up and running for testing purposes. I didn&rsquo;t do any due dilligence to lock this down in my vagrant environment but that would be a primary concern for me when rolling this out in a production environment.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/04/chef-getting-started-with-recipes/">Chef - Getting Started With Recipes</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-05-04T17:20:04-04:00" pubdate data-updated="true">May 4<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img class="center" src="/images/recipe_book.jpg"></p>

<p>Check out my primer chef document for how to initially configure your chef test environment with vagrant. This document assumes you are starting from there.</p>

<h1>Apache Tutorial Cookbook</h1>

<p>These are my expanded notes from one of the official <a href="https://learnchef.opscode.com/tutorials/create-your-first-cookbook/">docs</a>. Before we proceed, let&rsquo;s take a quick look at the default <a href="https://github.com/opscode/chef-repo">chef-repo</a> tree:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>chef-repo
</span><span class='line'>├── .chef
</span><span class='line'>├── certificates
</span><span class='line'>├── config
</span><span class='line'>├── cookbooks
</span><span class='line'>├── data_bags
</span><span class='line'>├── environments
</span><span class='line'>└── roles</span></code></pre></td></tr></table></div></figure>


<p>When you are inside that directory and have already configured your knife config file, you can start a cookbook with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>knife cookbook create apache_tutorial</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s see how this changes our workspace:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>chef-repo
</span><span class='line'>└── cookbooks
</span><span class='line'>        └── apache_tutorial
</span><span class='line'>            ├── attributes
</span><span class='line'>            ├── CHANGELOG.md
</span><span class='line'>            ├── definitions
</span><span class='line'>            ├── files
</span><span class='line'>            │   └── default
</span><span class='line'>            ├── libraries
</span><span class='line'>            ├── metadata.rb
</span><span class='line'>            ├── providers
</span><span class='line'>            ├── README.md
</span><span class='line'>            ├── recipes
</span><span class='line'>            │   └── default.rb
</span><span class='line'>            ├── resources
</span><span class='line'>            └── templates
</span><span class='line'>                └── default</span></code></pre></td></tr></table></div></figure>


<p>Make the following modifications:</p>

<p><code>recipes/default.rb</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package "apache2" do
</span><span class='line'>  action :install
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>service "apache2" do
</span><span class='line'>  action [ :enable, :start ]
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>cookbook_file "/var/www/index.html" do
</span><span class='line'>  source "index.html"
</span><span class='line'>  mode "0644"
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p><code>files/default/index.html</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;html&gt;
</span><span class='line'>&lt;body&gt;
</span><span class='line'>  &lt;h1&gt;Hello, world!&lt;/h1&gt;
</span><span class='line'>&lt;/body&gt;
</span><span class='line'>&lt;/html&gt;</span></code></pre></td></tr></table></div></figure>


<p>Upload that recipe to the chef server:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ knife cookbook upload apache_tutorial</span></code></pre></td></tr></table></div></figure>


<h1>Run List</h1>

<p>Now we need to add that recipe to our node&rsquo;s <code>run list</code>. To verify the run list of a node:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ knife node show chefclient
</span><span class='line'>Node Name:   chefclient
</span><span class='line'>Environment: _default
</span><span class='line'>FQDN:        ChefClient
</span><span class='line'>IP:          10.0.2.15
</span><span class='line'>Run List:    
</span><span class='line'>Roles:       
</span><span class='line'>Recipes:     
</span><span class='line'>Platform:    ubuntu 12.04
</span><span class='line'>Tags:</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s add our apache recipe to that node&rsquo;s runlist and confirm:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>knife node run_list add chefclient apache_tutorial
</span><span class='line'>chefclient:
</span><span class='line'>  run_list: recipe<span class="o">[</span>apache_tutorial<span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>knife node show chefclient
</span><span class='line'>Node Name:   chefclient
</span><span class='line'>Environment: _default
</span><span class='line'>FQDN:        ChefClient
</span><span class='line'>IP:          10.0.2.15
</span><span class='line'>Run List:    recipe<span class="o">[</span>apache_tutorial<span class="o">]</span>
</span><span class='line'>Roles:
</span><span class='line'>Recipes:
</span><span class='line'>Platform:    ubuntu 12.04
</span><span class='line'>Tags:
</span></code></pre></td></tr></table></div></figure>


<p>To force our chefclient to run this recipe and check into our chef server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>knife ssh <span class="s2">&quot;name:chefclient&quot;</span> -x vagrant -P vagrant <span class="s2">&quot;sudo chef-client&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h1>References</h1>

<ul>
<li><a href="http://docs.opscode.com/chef/resources.html">Chef Resources/Providers Reference</a></li>
<li><a href="https://learnchef.opscode.com/tutorials/create-your-first-cookbook/">Chef Tutorial</a></li>
<li><a href="http://docs.opscode.com/essentials_search.html">Chef Query</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/04/a-chef-primer/">A Chef Primer</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-05-04T17:19:40-04:00" pubdate data-updated="true">May 4<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img class="center" src="/images/chef_veggies.jpg"></p>

<h3>Vagrant</h3>

<p>My focus was to learn about Chef while using Vagrant for easy machine management. I&rsquo;m pretty familiar with the basics of vagrant already but there were two extras I needed for this project:
1. Quick snapshoting capabilities
2. Multi-machine setup for a Chef server and node</p>

<p>For 1. turns out you need a plugin for that. There are a few out there but I went with
<a href="https://github.com/dergachev/vagrant-vbox-snapshot">vagrant-vbox-snapshot</a>.</p>

<p>Snapshot plugin installation:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>vagrant plugin install vagrant-vbox-snapshot</span></code></pre></td></tr></table></div></figure>


<p>The base commands I care about are:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>vagrant snapshot take &lt;machine_name&gt; $snapshotname
</span><span class='line'>vagrant snapshot back &lt;machine_name&gt;</span></code></pre></td></tr></table></div></figure>


<p><a href="https://docs.vagrantup.com/v2/multi-machine/">Multi-machine</a> mode was fairly straightforward to configure. Here are the relevant pieces from my <code>Vagrantfile</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Vagrant.configure("2") do |config|
</span><span class='line'>
</span><span class='line'>    config.vm.define "chef-server", primary: true do |chefserver|
</span><span class='line'>        chefserver.vm.network :private_network, ip: "192.168.50.100"
</span><span class='line'>        chefserver.vm.box = "precise64"
</span><span class='line'>    end
</span><span class='line'>
</span><span class='line'>    config.vm.define "chef-node" do |chefnode|
</span><span class='line'>        chefnode.vm.network :private_network, ip: "192.168.50.10"
</span><span class='line'>        chefnode.vm.box = "precise64"
</span><span class='line'>    end
</span><span class='line'>
</span><span class='line'>    end
</span></code></pre></td></tr></table></div></figure>


<p>To jump between these two boxes you&rsquo;ll now need to specify the machine name. I
configured the chef server as the default machine with <code>primary: true</code> but you&rsquo;ll need
to refer to <code>chef-node</code> by name in your vagrant commands. For example, you can do
<code>vagrant ssh chef-node</code>.</p>

<h3>Chef Notes</h3>

<p>Chef key terms:</p>

<ul>
<li><code>server</code> &ndash; stores infrastructure pieces</li>
<li><code>workstation</code> &ndash; where you interact with chef server</li>
<li><code>nodes</code> &ndash; a node in your infrastructure</li>
<li><code>resources</code> &ndash; items to be manipulated (directories, files, etc.)

<ul>
<li>Represents a piece of the system and state. Such as a package to be installed, service to be running, file to be generated, user to be managed, etc.</li>
</ul>
</li>
<li><code>recipe</code> &ndash; configuration files that describe resources and their desired state. the &ldquo;work-horse&rdquo; of chef</li>
<li><code>cookbook</code> &ndash; hold recipes, templates, files, and custom resources.</li>
<li><code>organizations</code> &ndash; enterprise chef independent tenants</li>
<li><code>environments</code> &ndash; start with a single environment, can tag different life-stages and contain different data attributes.</li>
<li><code>roles</code> &ndash; represent types of servers. roles define policies.</li>
<li><code>run list</code> &ndash; list of chef configuration files that should be applied</li>
<li><code>nodes</code> &ndash;  represent the machines to be managed. can have 0+ roles. belong to one environment and one organization</li>
</ul>


<p><code>chef-client</code>
* Runs on each node
* gathers current system config and
* pulls down policy from chef server and enforce the policy on node</p>

<h4>High-level execution steps</h4>

<p>How Chef brings a machine in-line with policy:
1. Chef client periodically polls chef server to determine what policies should be running
2. The chef server figures that out and provides the client with a <code>run list</code>
3. The chef-client looks at each recipe in the <code>run list</code> and determines if it is in line with that policy.</p>

<h3>Chef-server Install</h3>

<ol>
<li>Download system package from chef install site</li>
<li>Depending on your platform, you&rsquo;ll probably utilize &lsquo;rpm&rsquo; or &lsquo;dpkg&rsquo; to install that</li>
<li>Ensure that DNS is properly configured for the server, or fake it by editing the <code>/etc/hosts</code> file</li>
<li>run <code>sudo chef-server-ctl reconfigure</code> which kicks off what essentially looks like a chef cookbook to build the chef server</li>
<li>You&rsquo;ll now have access to a chef web front-end on the server on standard web ports</li>
<li>You can login with admin / p@ssw0rd1</li>
</ol>


<h3>Chef workstation Install</h3>

<p>This is the computer(s) where you will manage the chef cookbooks and recipes. You should always be working from within your chef-repo (see further down).</p>

<h4>Quick install method</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>curl -L https://www.opscode.com/chef/install.sh | sudo bash
</span></code></pre></td></tr></table></div></figure>


<p>This includes:
* ruby
* knife
* chef-client
* ohai</p>

<p>You can also utilize ruby&rsquo;s gem installer with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo gem install chef
</span><span class='line'><span class="c">#or </span>
</span><span class='line'>gem install --user-install chef
</span><span class='line'><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;~/.gem/ruby/1.9.1/bin/:$PATH&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Chef-repo</h4>

<p>To set-up a propery formatted chef repo, start from <a href="https://github.com/opscode/chef-repo.git.">https://github.com/opscode/chef-repo.git.</a> You&rsquo;ll need to pull down a template repository and then link your repository to our chef server.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git clone https://github.com/opscode/chef-repo.git
</span><span class='line'>mkdir chef-repo/.chef
</span><span class='line'>touch chef-repo/.chef/chef-validator.pem
</span><span class='line'>touch chef-repo/.chef/admin.pem
</span></code></pre></td></tr></table></div></figure>


<p>Next, you&rsquo;ll need to pull in the certificates from the server. Log back into the web interface. Click <code>Clients</code> tab, then Chef-validator&rsquo;s <code>edit</code>, and regenerate the <code>Private key</code>. Copy the private key text from that page into the <code>chef-validator.pem</code> file we just created earlier. Do the same thing for the admin users, start with the <code>Users</code> tab and then dump the admin user&rsquo;s private key into the <code>admin.pem</code> file we created earlier.</p>

<h4>Knife</h4>

<p>knife is one of the primary command-line tools for managing chef instances. In order to bootstrap our knife configuration, you&rsquo;ll need to run the knife initial command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>msheiny:~/git/chef-repo<span class="o">]</span> ± knife configure -i
</span><span class='line'>WARNING: No knife configuration file found
</span><span class='line'>Where should I put the config file? <span class="o">[</span>/home/msheiny/.chef/knife.rb<span class="o">]</span> .chef/knife.rb
</span><span class='line'>Please enter the chef server URL: <span class="o">[</span>https://sheiny-desktop.sheiny.com:443<span class="o">]</span> https://chefserver
</span><span class='line'>Please enter a name <span class="k">for </span>the new user: <span class="o">[</span>msheiny<span class="o">]</span>
</span><span class='line'>Please enter the existing admin name: <span class="o">[</span>admin<span class="o">]</span>
</span><span class='line'>Please enter the location of the existing admin<span class="err">&#39;</span>s private key: <span class="o">[</span>/etc/chef-server/admin.pem<span class="o">]</span> .chef/admin.pem
</span><span class='line'>Please enter the validation clientname: <span class="o">[</span>chef-validator<span class="o">]</span>
</span><span class='line'>Please enter the location of the validation key: <span class="o">[</span>/etc/chef-server/chef-validator.pem<span class="o">]</span> .chef/chef-validator.pem
</span><span class='line'>Please enter the path to a chef repository <span class="o">(</span>or leave blank<span class="o">)</span>: /home/msheiny/git/chef-repo
</span><span class='line'>Creating initial API user...
</span><span class='line'>Please enter a password <span class="k">for </span>the new user:
</span><span class='line'>Created user<span class="o">[</span>msheiny<span class="o">]</span>
</span><span class='line'>Configuration file written to /home/msheiny/git/chef-repo/.chef/knife.rb
</span></code></pre></td></tr></table></div></figure>


<p>You can commit the repository at this time if you want. Just be weary of ensuring that the *pem files do not get commited or you might want to exclude the entire <code>.chef</code> directory altogether.</p>

<p>Test to make sure everything is working correctly by running &ndash; <code>knife user list</code></p>

<h4>Chef client Install</h4>

<p>We can bootstrap a chef client into our instance with help from knife!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>msheiny:~/git/chef-repo<span class="o">]</span> ± knife bootstrap chefclient.sheiny.com -x vagrant -P vagrant -N chefclient --sudo
</span></code></pre></td></tr></table></div></figure>


<p>The third argument is the fqdn of the node, <code>-x</code> and <code>-P</code> are the username/password, and <code>-N</code> is the name we want to refer to our new client by.</p>

<p>After that is done we can confirm with <code>client list</code> and we should see <code>chefclient</code> as part of the list:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>msheiny:~/git/chef-repo<span class="o">]</span> ± knife client list
</span></code></pre></td></tr></table></div></figure>


<h2>Resources</h2>

<ul>
<li><a href="http://www.getchef.com/chef/install/">Chef Install Site</a></li>
<li><a href="https://www.digitalocean.com/community/articles/how-to-install-a-chef-server-workstation-and-client-on-ubuntu-vps-instances">Third-party Chef Install Tutorial</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/03/17/mikrotik-and-me/">Mikrotik and Me</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-03-17T17:11:24-04:00" pubdate data-updated="true">Mar 17<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img class="left" src="/images/mikrotik_rtrb_750.jpg" width="400"></p>

<p>So I stumbled across a company out of Latvia that produces a line of hardware routers
and manages their own Linux-based network operating system. The hardware is called
<code>Routerboard</code> and the operating system is <code>RouterOS</code>. I needed a cheap but feature-filled home router and ended up picking up the RB750GL off Amazon. I can’t speak to performance or stability yet but so far I’m very happy with the extensibility and feature-set of RouterOS. I’ve always run dd-wrt in the past but have been turned off by the lack of documentation and the hoops you have to jump through to do more advanced tasks outside the web interface.
ssh logins</p>

<h2>SSH key logins</h2>

<p>You must utilize DSA ssh keys if you’d like to use ssh key authentication. From a linux host use <code>ssh-keygen</code> and the <code>-t</code> argument:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ssh-keygen -t dsa -i .ssh/mikrotik
</span><span class='line'>scp .ssh/mikrotik.pub $mikrotik_ip:</span></code></pre></td></tr></table></div></figure>


<p>on the mikrotik:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[msheiny@mikrotik] &gt; /user ssh-keys import public-key-file=mikrotik.pub user=msheiny</span></code></pre></td></tr></table></div></figure>


<h2>IPv6 with comcast</h2>

<p>Comcast uses <a href="http://tools.ietf.org/html/rfc3633">DHCP-PD</a> to pass along our /64 network prefix. Add a dhcpv6 client to our external interface:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/ipv6 dhcp-client
</span><span class='line'>add add-default-route=yes interface=ether1-gateway pool-name=comcast</span></code></pre></td></tr></table></div></figure>


<p>and then add firewall rules:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/ipv6 firewall filter
</span><span class='line'>add chain=input connection-state=established
</span><span class='line'>add chain=input connection-state=related
</span><span class='line'>add chain=input dst-port=546 in-interface=ether1-gateway protocol=udp
</span><span class='line'>add chain=input in-interface=ether1-gateway protocol=icmpv6
</span><span class='line'>add action=drop chain=input in-interface=ether1-gateway
</span><span class='line'>add chain=forward connection-state=established
</span><span class='line'>add chain=forward connection-state=related
</span><span class='line'>add action=drop chain=forward connection-state=invalid</span></code></pre></td></tr></table></div></figure>


<p>advertise that route to our internal client ports:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/ipv6 address
</span><span class='line'>add eui-64=yes from-pool=comcast interface=ether4    </span></code></pre></td></tr></table></div></figure>


<h2>Finishing up</h2>

<p>Let’s turn off services we arent using:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/ip firewall service-port
</span><span class='line'>set ftp disabled=yes
</span><span class='line'>set tftp disabled=yes
</span><span class='line'>set irc disabled=yes
</span><span class='line'>set h323 disabled=yes
</span><span class='line'>set sip disabled=yes
</span><span class='line'>set pptp disabled=yes
</span><span class='line'>/ip hotspot service-port
</span><span class='line'>set ftp disabled=yes
</span><span class='line'>/ip service
</span><span class='line'>set telnet disabled=yes
</span><span class='line'>set ftp disabled=yes
</span><span class='line'>set api disabled=yes
</span><span class='line'>set winbox disabled=yes
</span><span class='line'>set api-ssl disabled=yes</span></code></pre></td></tr></table></div></figure>


<p>Configure ntp:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/system clock
</span><span class='line'>set time-zone-name=America/New_York
</span><span class='line'>
</span><span class='line'>/system ntp client
</span><span class='line'>set enabled=yes mode=unicast primary-ntp=x.x.x.x secondary-ntp=y.y.y.y</span></code></pre></td></tr></table></div></figure>


<p>Hostname:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/system identity
</span><span class='line'>set name=homerouter</span></code></pre></td></tr></table></div></figure>


<p>ToDo</p>

<ul>
<li>Get a cron job going updating a dynamic dns entry. So far I’ve had success using the following code that is specific for no-ip.com that I found on the Mikrotik script repository:</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>##############Script Settings##################
</span><span class='line'>
</span><span class='line'>:local NOIPUser "sheiny"
</span><span class='line'>:local NOIPPass "asdasdzxdzsdfsfdsfxf"
</span><span class='line'>:local WANInter "ether1-gateway"
</span><span class='line'>:local NOIPDomain "myhost"
</span><span class='line'>
</span><span class='line'>###############################################
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>:local IpCurrent [/ip address get [find interface=$WANInter] address];
</span><span class='line'>:for i from=( [:len $IpCurrent] - 1) to=0 do={
</span><span class='line'>    :if ( [:pick $IpCurrent $i] = "/") do={
</span><span class='line'>     :local NewIP [:pick $IpCurrent 0 $i];
</span><span class='line'>     :if ([:resolve $NOIPDomain] != $NewIP) do={
</span><span class='line'>       /tool fetch mode=https user=$NOIPUser password=$NOIPPass url="https://dynupdate.no-ip.com/nic/update\3Fhostname=$NOIPDomain&myip=$NewIP" keep-result=no
</span><span class='line'>       :log info "NO-IP Update: $NOIPDomain - $NewIP"
</span><span class='line'>      }
</span><span class='line'>    }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>    Get a VPN up and running (or maybe just utilize SSH with keys + forwarding)
</span><span class='line'>    Script to email daily digest of network activity and router status changes
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/03/06/freeradius-and-google-pam/">Freeradius and Google Authenticator</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-03-06T18:56:20-05:00" pubdate data-updated="true">Mar 6<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Caveat</h2>

<p>freeradius is a bit baffling to get a full grasp on and I don&rsquo;t pretend to be an expert. My goals were two-fold &ndash; radius users authenticate against pam (<code>rlm_pam</code>) with two-factor google authenticator and ensure freeradius doesn&rsquo;t have to run as root.</p>

<p>Logistically, The two-factor code will come in AFTER (no space, enter, etc) the user&rsquo;s password like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>user: &lt;username&gt;
</span><span class='line'>password: &lt;password&gt;&lt;googlecode&gt;</span></code></pre></td></tr></table></div></figure>


<h2>Radius Files</h2>

<p>By default, freeradius config files will be found in <code>/etc/raddb</code>. From the start you will be concerned with:</p>

<ul>
<li><code>radiusd.conf</code> &ndash; lists all the relevant paths of radius files. sets radiusd permissions</li>
<li><code>sites-enabled/default</code> &ndash; default site configuration parameters specified. Lists enabled modules for aaa</li>
<li><code>clients.conf</code> &ndash; This file defines radius clients by IP or subnet that are allowed to connect, client specific parameters, and where you will indicate the secret shared key.</li>
<li><code>users</code> &ndash; You can list users in this file if you want and define parameters of groups. This is an optional file technically which is enabled by default thanks to the &lsquo;files&rsquo; parameter listed in the &lsquo;default&rsquo; sites file.</li>
<li><code>/etc/pam.d/radiusd</code> &ndash; pam parameters to run for the radiusd rlm_pam module</li>
</ul>


<p>In <code>radiusd.conf</code>, modified the following under the authenticate section (used to be pap):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Auth-Type PAP {
</span><span class='line'>      pam
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>So, I wanted to allow users on the local system that are in the <code>switchuser</code> group and also a user named rancid. Everyone else should fail out. My rancid user is used for scraping configs and doesn&rsquo;t have full command rights. Part of this setup involves configuring the privilege level commands on the IOS device itself. I set some system specific Appended the following to <code>users</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># 
</span><span class='line'># Allow Unix users that are in the switchuser group
</span><span class='line'>#
</span><span class='line'>DEFAULT Group == 'switchuser' 
</span><span class='line'>    foundry-privilege-level := 0,
</span><span class='line'>    foundry-command-string := "*",
</span><span class='line'>    cisco-avpair = "shell:priv-lvl=4",
</span><span class='line'>
</span><span class='line'>#
</span><span class='line'># Rancid user is only allowed show run commands
</span><span class='line'>#
</span><span class='line'>rancid
</span><span class='line'>    foundry-command-string := "show running-config ;show conf*; show vlan",
</span><span class='line'>    foundry-privilege-level := 5,
</span><span class='line'>    foundry-command-exception-flag := 0,
</span><span class='line'>    cisco-avpair = "shell:priv-lvl=4",
</span><span class='line'>
</span><span class='line'># On no match, the user is denied access.
</span><span class='line'>DEFAULT Auth-Type := REJECT
</span></code></pre></td></tr></table></div></figure>


<h2>Google Authenticator Pam &ldquo;Hack&rdquo;</h2>

<p>I use the term &ldquo;hack&rdquo; very very loosely. I merely just commented out a line really. Okay, 4 lines. <em>ahem</em> Anyways&hellip;</p>

<p>If you run radiusd without root permissions, you&rsquo;ll have problems trying to use the google auth pam module. This is because it wants to change uid/gid to the incoming user by default. I did three things to get around this:</p>

<ol>
<li>I set the <code>secret=/var/run/user/${USER}/.google_authenticator</code> parameter. Will need all users to copy their files here and chown this folder to the same user that will be running radiusd</li>
<li>I forced the user with the <code>user=radiusd</code></li>
<li>I re-compiled the source for the google pam module and commented out a fail value when it tries to change group id. (see below)</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>*** pam_google_authenticator.c  2012-05-14 21:32:27.000000000 -0400
</span><span class='line'>--- /tmp/libpam-google-authenticator-1.0/pam_google_authenticator.c     2014-03-05 13:17:33.777588058 -0500
</span><span class='line'>***************
</span><span class='line'>*** 311,320 ****
</span><span class='line'>        // Inform the caller that we were unsuccessful in resetting the uid.
</span><span class='line'>        *old_uid = uid_o;
</span><span class='line'>      }
</span><span class='line'>!     log_message(LOG_ERR, pamh,
</span><span class='line'>!                 "Failed to change group id for user \"%s\" to %d", username,
</span><span class='line'>!                 (int)gid);
</span><span class='line'>!     return -1;
</span><span class='line'>    }
</span><span class='line'>  
</span><span class='line'>    *old_uid = uid_o;
</span><span class='line'>--- 311,325 ----
</span><span class='line'>        // Inform the caller that we were unsuccessful in resetting the uid.
</span><span class='line'>        *old_uid = uid_o;
</span><span class='line'>      }
</span><span class='line'>!     //      In order to run RADIUS without root permissions, I commented
</span><span class='line'>!     //      out the failure on setgroup and logging code below. This also
</span><span class='line'>!     //      required me to feed the 'user=' option in the pam radius file.
</span><span class='line'>!     //
</span><span class='line'>!     //log_message(LOG_ERR, pamh,
</span><span class='line'>!     //            "Failed to change group id for user \"%s\" to %d", username,
</span><span class='line'>!     //            (int)gid);
</span><span class='line'>!     // return -1;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    *old_uid = uid_o;</span></code></pre></td></tr></table></div></figure>


<p>My <code>/etc/pam.d/radiusd</code> now looks like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#%PAM-1.0
</span><span class='line'>auth     required       pam_google_authenticator.so forward_pass secret=/var/run/user/${USER}/.google_authenticator user=radiusd
</span><span class='line'>auth     requisite      pam_nologin.so
</span><span class='line'>auth     include        common-auth
</span><span class='line'>account  include        common-account
</span><span class='line'>password include        common-password
</span><span class='line'>session  include        common-session
</span></code></pre></td></tr></table></div></figure>


<p><code>forward_pass</code> produces the functionality explained at the top (google code follows password).</p>

<h2>Fire!</h2>

<p>Start up the server in debug mode with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>msheiny:~<span class="o">]</span> <span class="nv">$ </span>radiusd -X
</span></code></pre></td></tr></table></div></figure>


<p>Start firing packets at your instance with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>msheiny:~<span class="o">]</span> <span class="nv">$ </span>radtest msheiny <span class="o">{</span>password<span class="o">}{</span>google_code<span class="o">}</span> localhost <span class="o">{</span>port<span class="o">}</span> <span class="o">{</span>shared_key<span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>shared_key</code> is a value found in the clients file</li>
</ul>

</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/05/05/jenkins-primer/">Jenkins Primer</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/04/chef-getting-started-with-recipes/">Chef - Getting Started With Recipes</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/04/a-chef-primer/">A Chef Primer</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/03/17/mikrotik-and-me/">Mikrotik and Me</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/03/06/freeradius-and-google-pam/">Freeradius and Google Authenticator</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/msheiny">@msheiny</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'msheiny',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Mike Sheinberg -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
